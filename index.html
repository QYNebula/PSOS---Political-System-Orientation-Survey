<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Political Orientation Scanner</title>
    <style>
        :root { --primary: #2196F3; --success: #4CAF50; --error: #f44336; --bg: #f5f7f9; }
        body { font-family: "微软雅黑", sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { background: white; width: 95%; max-width: 800px; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        #lang-select { text-align: center; }
        .lang-dropdown { padding: 12px 20px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd; width: 80%; max-width: 300px; margin-bottom: 20px; outline: none; }
        .start-btn { background: var(--primary); color: white; padding: 12px 40px; font-size: 1rem; border-radius: 8px; border: none; cursor: pointer; transition: 0.3s; }
        .start-btn:hover { background: #1976D2; }

        .progress { color: #888; font-size: 14px; margin-bottom: 10px; }
        .question-text { font-size: 1.25rem; font-weight: bold; margin-bottom: 25px; min-height: 60px; line-height: 1.5; color: #333; }
        .option { display: block; width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; background: white; font-size: 1rem; }
        .option:hover { background: #f0f7ff; border-color: var(--primary); }
        .option.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .nav { display: flex; gap: 15px; margin-top: 30px; }
        
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: opacity 0.2s; }
        .prev-btn { background: #e0e0e0; color: #333; }
        .next-btn { background: var(--success); color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #result-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100; }
        .result-card { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 12px; max-height: 85vh; overflow-y: auto; }
        .report-content { white-space: pre-wrap; background: #f9f9f9; padding: 20px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; border: 1px solid #eee; font-family: "Consolas", monospace; }
        .paradox-banner { background: #fff1f0; border-left: 5px solid var(--error); padding: 10px; margin-bottom: 15px; color: var(--error); font-weight: bold; }
        .version-tag { font-size: 11px; color: #ccc; margin-top: 15px; text-align: right; }
    </style>
</head>
<body>

<div id="app">
    <div id="lang-select">
        <h2 id="lang-title">Please Select Language / 请选择语言</h2>
        <select id="lang-menu" class="lang-dropdown">
            <option value="zh-cn">简体中文</option>
            <option value="en" disabled>English</option>
        </select>
        <br>
        <button class="start-btn" onclick="handleStart()">Start / 开始测试</button>
    </div>

    <div id="quiz-container" style="display: none;">
        <div class="progress" id="progress"></div>
        <div class="question-text" id="question-text"></div>
        <div id="options-container"></div>
        <div class="nav">
            <button class="prev-btn" id="prev-btn" onclick="prevQuestion()"></button>
            <button class="next-btn" id="next-btn" onclick="submitAnswer()" disabled></button>
        </div>
    </div>
</div>

<div id="result-overlay">
    <div class="result-card">
        <h3 id="result-title"></h3>
        <div id="paradox-alert-area"></div>
        <div class="report-content" id="report-text"></div>
        <div class="version-tag" id="app-version"></div>
        <button class="next-btn" style="margin-top:20px; width:100%" id="reset-btn" onclick="resetQuiz()"></button>
    </div>
</div>

<script>
    const CORE_VERSION = "v3.3.4"; 
    let quizData = null;
    let currentIndex = 0;
    let userAnswers = {};
    let history = [];

    function handleStart() {
        const selectedLang = document.getElementById('lang-menu').value;
        initQuiz(selectedLang);
    }

    async function initQuiz(lang) {
        try {
            const response = await fetch(`questions_${lang}.json`);
            if (!response.ok) throw new Error("File not found");
            quizData = await response.json();
            setupUI();
            document.getElementById('lang-select').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            showQuestion();
        } catch (error) {
            alert("加载失败，请确保 questions_zh.json 已上传。");
        }
    }

    function setupUI() {
        const ui = quizData.ui;
        document.getElementById('prev-btn').innerText = ui.prev_btn;
        document.getElementById('next-btn').innerText = ui.next_btn;
        document.getElementById('result-title').innerText = ui.result_title;
        document.getElementById('reset-btn').innerText = ui.reset_btn;
        document.getElementById('app-version').innerText = `Engine: ${CORE_VERSION}`;
    }

    function showQuestion() {
        const q = quizData.quiz_data.questions[currentIndex];
        const ui = quizData.ui;
        document.getElementById('progress').innerText = `${ui.progress_prefix}${currentIndex + 1} / ${quizData.quiz_data.questions.length}`;
        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = `option ${userAnswers[currentIndex] === i ? 'selected' : ''}`;
            btn.innerText = opt.text;
            btn.onclick = () => selectOption(i);
            container.appendChild(btn);
        });
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').disabled = userAnswers[currentIndex] === undefined;
    }

    function selectOption(index) {
        userAnswers[currentIndex] = index;
        document.querySelectorAll('.option').forEach((btn, i) => btn.classList.toggle('selected', i === index));
        document.getElementById('next-btn').disabled = false;
    }

    function submitAnswer() {
        history.push(currentIndex);
        currentIndex++;
        if (currentIndex < quizData.quiz_data.questions.length) showQuestion();
        else generateAnalysis();
    }

    function prevQuestion() {
        if (history.length > 0) { currentIndex = history.pop(); showQuestion(); }
    }

    // 核心算法
    function generateAnalysis() {
        let scores = {};
        const axes = ['X1','X2','X3','X4','X5','X6','X7','Y1','Y2','Y3','Y4','Y5'];
        const vectors = ['vector_bureaucracy','vector_negotiation','vector_elitism','vector_cabinet'];
        [...axes, ...vectors].forEach(k => scores[k] = 0);

        for (let qIdx in userAnswers) {
            let weights = quizData.quiz_data.questions[qIdx].options[userAnswers[qIdx]].weights;
            for (let k in weights) { scores[k] = (scores[k] || 0) + weights[k]; }
        }

        let bestX = ['X1','X2','X3','X4','X5','X6','X7'].reduce((a, b) => scores[a] >= scores[b] ? a : b);
        let bestY = ['Y1','Y2','Y3','Y4','Y5'].reduce((a, b) => scores[a] >= scores[b] ? a : b);
        
        const labels = quizData.ui.report_labels;
        const logicMap = quizData.quiz_data.logic_map;
        const paradoxMap = quizData.quiz_data.paradox_map;
        let modeKey = "exact"; //初始定性为精准匹配

        // 1. 悖论判定
        if (paradoxMap[bestX + bestY]) {
            displayResult(paradoxMap[bestX + bestY], "paradox", bestX, bestY, scores, labels);
            return;
        }

        // 2. 逻辑重定向 (X7Y4 -> X7Y5)
        if (bestX === "X7" && bestY === "Y4") {
            bestY = "Y5";
            modeKey = "approx";
        }

        // 3. 坐标近似计算
        let finalCoord = bestX + bestY;
        if (!logicMap[finalCoord]) {
            let definedYs = Object.keys(logicMap).filter(k => k.startsWith(bestX)).map(k => parseInt(k.split('Y')[1]));
            if (definedYs.length > 0) {
                let curYVal = parseInt(bestY.substring(1));
                let closestY = definedYs.reduce((prev, curr) => Math.abs(curr - curYVal) < Math.abs(prev - curYVal) ? curr : prev);
                bestY = "Y" + closestY;
                finalCoord = bestX + bestY;
                modeKey = "approx"; 
            }
        }

        // 4. 特殊向量拦截
        let finalTitle, finalDesc;
        if (finalCoord === "X6Y4") {
            if ((scores.vector_cabinet || 0) >= 2.0) {
                [finalTitle, finalDesc] = logicMap["X3Y4"];
            } else if ((scores.vector_negotiation || 0) >= 1.5) {
                [finalTitle, finalDesc] = logicMap["X6Y4_negotiation"];
            } else {
                [finalTitle, finalDesc] = logicMap["X6Y4"];
            }
        } else if (finalCoord === "X2Y2" && (scores.vector_bureaucracy || 0) > (scores.vector_elitism || 0)) {
            [finalTitle, finalDesc] = logicMap["X2Y2_bureaucracy"];
        } else {
            const result = logicMap[finalCoord] || labels.no_match;
            [finalTitle, finalDesc] = result;
        }

        displayResult([finalTitle, finalDesc], modeKey, bestX, bestY, scores, labels);
    }

    function displayResult(contentArray, modeKey, x, y, scores, labels) {
        const [title, desc] = contentArray;
        document.getElementById('paradox-alert-area').innerHTML = (modeKey === "paradox") ? `<div class="paradox-banner">${labels.paradox_alert}</div>` : '';

        const report = `${labels.coord}: ${x} - ${y}\n` +
                       `${labels.mode}: ${labels.modes[modeKey]}\n\n` +
                       `${labels.matched}: ${title}\n` +
                       `${labels.desc}: ${desc}\n\n` +
                       `${labels.stats_title}\n` +
                       `${labels.axis_x}: ${x} (${scores[x].toFixed(1)})\n` +
                       `${labels.axis_y}: ${y} (${scores[y].toFixed(1)})\n` +
                       `${labels.special_vectors}:\n` +
                       ` - ${labels.vector_bureaucracy}: ${(scores.vector_bureaucracy || 0).toFixed(1)}\n` +
                       ` - ${labels.vector_negotiation}: ${(scores.vector_negotiation || 0).toFixed(1)}`;

        document.getElementById('report-text').innerText = report;
        document.getElementById('result-overlay').style.display = 'flex';
    }

    function resetQuiz() {
        currentIndex = 0; userAnswers = {}; history = [];
        document.getElementById('result-overlay').style.display = 'none';
        showQuestion();
    }
</script>
</body>
</html>

